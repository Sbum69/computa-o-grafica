<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chuva Residual</title>
<style>
	body {
		display: flex;
		justify-content: center;
		align-items: center;
		height: 100vh;
		margin: 0;
	}
	canvas {
		border: 3px solid #2e7d32; /* verde */
		background-color: #e0f7fa;
	}
</style>
</head>

<body>
	<canvas id="gameCanvas" width="600" height="400">O seu navegador não suporta Canvas.</canvas>

	<script type="module">
		// importar robo e lixos
		import { robo, updateRobo, drawRobo } from "./robot.js";
		import * as Lixos from "./lixos.js";

		// parte principal
		const canvas = document.getElementById("gameCanvas");
		const ctx = canvas.getContext("2d");

		const W = canvas.width;
		const H = canvas.height;

		// lixo
		const chuvaLista = [];
		let spawnTimer = 0;

		function criarLixo() {
			const x = Math.random() * (W - 100);

			const tiposLixo = Object.values(Lixos);
			const LixoClasse = tiposLixo[Math.floor(Math.random() * tiposLixo.length)];

			const obj = new LixoClasse(x);
			chuvaLista.push(obj);
		}

		function porNoLixo() {
			const binX = W - 80;
			const binY = H - 100;

			if (robo.x + robo.w > binX && robo.x < binX + 60) {
				for (const obj of chuvaLista) {
					if (obj.onRobot) {
						obj.onRobot = false;
						obj.jumpingToBin = true;
						obj.jumpProgress = 0;
					}
				}
			}
		}

		function render() {
			// fundo
			ctx.fillStyle = "#b3e5fc";
			ctx.fillRect(0, 0, W, H);

			// chão
			ctx.fillStyle = "#81c784";
			ctx.fillRect(0, H - 40, W, 40);

			// caixote de lixo
			ctx.fillStyle = "#4caf50";
			ctx.fillRect(W - 80, H - 100, 60, 60);

			// cair lixo ocasionalmente
			spawnTimer++;
			if (spawnTimer > 100) {
				criarLixo();
				spawnTimer = 0;
			}

			// atualizar e desenhar lixo
			for (const obj of chuvaLista) {
				obj.update(robo, W - 50, H - 100);
				obj.draw(ctx);
			}

			// quanto mais peso, mais lento o robô
			const totalWeight = chuvaLista
				.filter(o => o.onRobot)
				.reduce((sum, o) => sum + o.weight, 0);
			robo.speed = 6 / (1 + totalWeight * 0.075);

			updateRobo(W);
			drawRobo(ctx);
			porNoLixo();

			// remover lixo posto no caixote
			for (let i = chuvaLista.length - 1; i >= 0; i--) {
				if (chuvaLista[i].collected) chuvaLista.splice(i, 1);
			}

			requestAnimationFrame(render);
		}

		render();
	</script>
</body>
</html>